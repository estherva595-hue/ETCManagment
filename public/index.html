<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotional Therapy Clinique</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: url('myMainBG.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #222;
        }

        .intro {
            background: rgba(255, 255, 255, 0.8);
            max-width: 600px;
            margin: 100px auto 20px auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.85);
            max-width: 400px;
            margin: 0 auto 40px auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        .login-box input {
            width: 80%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
        }

        .login-box button {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            background: #4a90e2;
            color: #fff;
            font-size: 1em;
            cursor: pointer;
        }

        .login-box button:hover {
            background: #357abd;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 220px;
            background: rgba(74, 144, 226, 0.95);
            color: #fff;
            padding: 30px 0;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .sidebar button {
            background: none;
            border: none;
            color: #fff;
            padding: 14px 24px;
            text-align: left;
            font-size: 1em;
            cursor: pointer;
            width: 100%;
        }

        .sidebar button:hover {
            background: #357abd;
        }

        .main-content {
            flex: 1;
            background: rgba(255, 255, 255, 0.85);
            padding: 40px;
            min-height: 100vh;
        }
    </style>
</head>

<body>
    <div class="intro" id="intro">
        <h1>Welcome to Emotional Therapy Clinique</h1>
        <p>
            At Emotional Therapy Clinique, we are dedicated to supporting your emotional well-being.
            Our experienced therapists provide a safe and compassionate environment to help you navigate life's
            challenges,
            foster personal growth, and achieve lasting emotional balance.
        </p>
    </div>
    <div class="login-box" id="login-box">
        <input type="text" id="username" placeholder="Username" />
        <br>
        <input type="password" id="password" placeholder="Password" />
        <br>
        <button onclick="submitLogin()">Login</button>
    </div>
    <div id="app" style="display:none;">
        <div class="app-container">
            <div class="sidebar" id="sidebar"></div>
            <div class="main-content" id="main-content">
                <h2>Welcome!</h2>
                <p>Select an option from the sidebar.</p>
            </div>
        </div>
    </div>
    <script>
        function submitLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            fetch('/loginUser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.RoleID !== undefined) {  // Only check for RoleID as before
                        window.currentRoleId = data.RoleID;
                        window.currentUserId = data.UserID; // Still store UserID if it exists
                        showApp(data.RoleID);
                    } else {
                        alert(data.msg || 'Login failed');
                    }
                })
                .catch(error => {
                    alert('Error logging in');
                });
        }


        function sendPatientSearch() {
            const idNumber = document.getElementById('patientId').value;
            const therapistId = window.currentUserId;
            console.log('Sending search request - therapistId:', therapistId, 'idNumber:', idNumber);
            fetch('/searchPatient', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ therapistId, idNumber })
            })
                .then(response => {
                    if (response.status === 403) {
                        document.getElementById('patientResult').innerHTML = 'Forbidden: You are not assigned to this patient.';
                        return null;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        const formattedDate = new Date(data.DateOfBirth).toLocaleDateString('he-IL');
                        const patientHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="margin-top: 0; color: #333;">Patient Information</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">First Name:</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${data.FirstName}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">Last Name:</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${data.LastName}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">Date of Birth:</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${formattedDate}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">Health Fund:</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${data.FundName || 'No Fund'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">ID Number:</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${data.IDNumber}</td>
                        </tr>
                    </table>
                </div>
            `;
                        document.getElementById('patientResult').innerHTML = patientHTML;
                        // Hide search button after finding patient
                        document.getElementById('searchButton').style.display = 'none';
                        // Show treatment module and load history
                        document.getElementById('treatmentModule').style.display = 'block';
                        loadTreatmentHistory(document.getElementById('patientId').value);
                    }
                })
                .catch(() => {
                    document.getElementById('patientResult').innerHTML = 'Error searching patient.';
                    document.getElementById('treatmentModule').style.display = 'none';
                });
        }


        //---------------------------------------------------------------

        function showApp(roleId) {
            document.getElementById('intro').style.display = 'none';
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('app').style.display = 'block';

            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = ''; // Clear previous

            let options = [];
            if (roleId == 1) {
                options = [
                    'Terapist Module',
                    'Browse',
                    'Adm. Secretary Module',
                    'Patients',
                    'Payment',
                    'Personalized Picks'
                ];
            } else if (roleId == 2) {
                options = [
                    'Browse',
                    'Adm. Secretary Module',
                    'Patients',
                    'Payment'
                ];
            } else if (roleId == 3) {
                options = [
                    'Terapist Module'
                ];
            } else if (roleId == 4) {
                options = [
                    'Terapist Module'
                ];
            }

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.textContent = opt;
                btn.onclick = () => showContent(opt);
                sidebar.appendChild(btn);
            });
        }

        function showContent(option) {
            const main = document.getElementById('main-content');
            main.innerHTML = `<h2>${option}</h2><p>Content for "${option}" will appear here.</p>`;
            if (option === "Terapist Module" && (window.currentRoleId == 3 || window.currentRoleId == 4)) {
                showTherapistModule();
            } else if (option === "Patients" && (window.currentRoleId == 1 || window.currentRoleId == 2)) {
                showPatientForm();
            }
        }

        function showPatientForm() {
            const main = document.getElementById('main-content');
            main.innerHTML = `
                <h2>New Patient Registration</h2>
                <form id="newPatientForm" onsubmit="return submitPatientForm(event)" style="max-width: 600px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">First Name <span style="color: #d93025;">*</span></label>
                        <input type="text" id="firstName" required dir="rtl" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Last Name <span style="color: #d93025;">*</span></label>
                        <input type="text" id="lastName" required dir="rtl" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">ID Number <span style="color: #d93025;">*</span></label>
                        <input type="text" id="idNumber" required pattern="\\d{9}" maxlength="9" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <div id="idNumberError" style="color: #d93025; font-size: 0.9em; margin-top: 5px; display: none;">ID must be exactly 9 digits</div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Date of Birth <span style="color: #d93025;">*</span></label>
                        <input type="date" id="dateOfBirth" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Gender</label>
                        <select id="gender" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">Select Gender</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                            <option value="O">Other</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Health Fund</label>
                        <select id="fundId" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">Select Health Fund</option>
                        </select>
                    </div>
                    <div style="margin-top: 30px;">
                        <button type="submit" style="padding: 12px 24px; border: none; border-radius: 6px; background: #4a90e2; color: white; font-size: 1em; cursor: pointer;">Register Patient</button>
                    </div>
                </form>
            `;
            loadHealthFunds();
        }

        async function loadHealthFunds() {
            try {
                const response = await fetch('/api/healthFunds');
                const funds = await response.json();
                const select = document.getElementById('fundId');
                if (select) {
                    funds.forEach(fund => {
                        const option = document.createElement('option');
                        option.value = fund.FundID;
                        option.textContent = fund.FundName;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading health funds:', error);
            }
        }

        function showTherapistModule() {
            const main = document.getElementById('main-content');
            main.innerHTML = `
                <h2>Patient Record</h2>
                <div id="searchSection" style="margin-bottom: 20px;">
                    <label for="patientId">Patient ID Number:</label>
                    <input type="text" id="patientId" maxlength="9" style="margin-left: 10px;" />
                    <button id="searchButton" onclick="sendPatientSearch()">Search</button>
                </div>
                <div id="patientResult"></div>
                <div id="treatmentModule" style="display: none; margin-top: 30px;">
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 1;">
                            <h3>היסטוריית פגישות</h3>
                            <div id="treatmentHistory" style="border: 1px solid #ddd; padding: 15px; height: 300px; overflow-y: auto; background: #f9f9f9;"></div>
                        </div>
                        <div style="flex: 1;">
                            <h3>עדכון פגישה</h3>
                            <div style="border: 1px solid #ddd; padding: 15px; background: white;">
                                <div style="margin-bottom: 15px;">
                                    <label>Treatment Type:</label>
                                    <select id="treatmentType" style="width: 100%; padding: 8px; margin-top: 5px;"></select>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label>Treatment Template:</label>
                                    <select id="treatmentTemplate" style="width: 100%; padding: 8px; margin-top: 5px;"></select>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label>סיכום הפגישה:</label>
                                    <textarea id="treatmentSummary" rows="4" style="width: 100%; padding: 8px; margin-top: 5px;"></textarea>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label>המלצות:</label>
                                    <textarea id="recommendations" rows="4" style="width: 100%; padding: 8px; margin-top: 5px;"></textarea>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="createNewTreatment()" style="padding: 10px 20px; background: #4a90e2; color: white; border: none; border-radius: 4px;">Save Appointment</button>
                                    <button onclick="scheduleNext()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px;">Schedule Next Appointment</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadTreatmentHistory(idNumber) {
            try {
                // Load treatment types and templates first
                await loadTreatmentTypes();
                await loadTreatmentTemplates();
                
                const response = await fetch('/api/treatmentHistory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ therapistId: window.currentUserId, idNumber })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load treatment history');
                }
                
                const treatments = await response.json();
                const historyDiv = document.getElementById('treatmentHistory');
                const treatmentSelect = document.getElementById('treatmentSelect');
                
                if (treatments.length === 0) {
                    historyDiv.innerHTML = '<p>אין היסטוריית פגישות</p>';
                    treatmentSelect.innerHTML = '<option value="">אין פגישות זמינות</option>';
                    return;
                }
                
                // Display history
                historyDiv.innerHTML = treatments.map(t => `
                    <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background: white;">
                        <strong>תאריך:</strong> ${new Date(t.TreatmentDate).toLocaleDateString('he-IL')}<br>
                        <strong>סוג טיפול:</strong> ${t.TreatmentType || t.TreatmentTypeName || 'לא צוין'}<br>
                        <strong>סיכום:</strong> ${t.TreatmentSummary || 'אין סיכום'}<br>
                        <strong>המלצות:</strong> ${t.Recommendations || 'אין המלצות'}
                    </div>
                `).join('');
                
                // Clear form for new treatment entry
                document.getElementById('treatmentType').value = '';
                document.getElementById('treatmentTemplate').value = '';
                document.getElementById('treatmentSummary').value = '';
                document.getElementById('recommendations').value = '';
                
            } catch (error) {
                console.error('Error loading treatment history:', error);
                document.getElementById('treatmentHistory').innerHTML = '<p>שגיאה בטעינת היסטוריית הפגישות</p>';
            }
        }

        async function loadTreatmentTypes() {
            try {
                console.log('Loading treatment types...');
                const response = await fetch('/api/treatmentTypes');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const types = await response.json();
                console.log('Treatment types loaded:', types);
                const select = document.getElementById('treatmentType');
                
                if (!select) {
                    console.error('Treatment type select element not found');
                    return;
                }
                
                select.innerHTML = '<option value="">Select Treatment Type</option>' +
                    types.map(type => `<option value="${type.TypeName}">${type.TypeName}</option>`).join('');
                    
            } catch (error) {
                console.error('Error loading treatment types:', error);
            }
        }

        async function loadTreatmentTemplates() {
            try {
                const response = await fetch('/api/treatmentTemplates');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const templates = await response.json();
                const select = document.getElementById('treatmentTemplate');
                
                if (!select) {
                    console.error('Treatment template select element not found');
                    return;
                }
                
                select.innerHTML = '<option value="">Select Template (Optional)</option>' +
                    templates.map(template => `<option value="${template.TemplateID}">${template.TemplateName}</option>`).join('');
                    
            } catch (error) {
                console.error('Error loading treatment templates:', error);
            }
        }

        async function createNewTreatment() {
            const idNumber = document.getElementById('patientId').value;
            const treatmentType = document.getElementById('treatmentType').value;
            const templateId = document.getElementById('treatmentTemplate').value || null;
            const treatmentSummary = document.getElementById('treatmentSummary').value;
            const recommendations = document.getElementById('recommendations').value;
            
            if (!treatmentType || !treatmentSummary) {
                alert('Please fill in Treatment Type and Summary');
                return;
            }
            
            try {
                const response = await fetch('/api/createTreatment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        therapistId: window.currentUserId,
                        idNumber,
                        treatmentType,
                        treatmentSummary,
                        recommendations,
                        templateId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create treatment');
                }
                
                alert('New treatment session created successfully!');
                // Clear form and reload history
                document.getElementById('treatmentType').value = '';
                document.getElementById('treatmentTemplate').value = '';
                document.getElementById('treatmentSummary').value = '';
                document.getElementById('recommendations').value = '';
                loadTreatmentHistory(idNumber);
                
            } catch (error) {
                console.error('Error creating treatment:', error);
                alert('Error creating treatment session');
            }
        }

        function scheduleNext() {
            alert('פונקציונליות קביעת תור הבא תתווסף בהמשך');
        }

        async function submitPatientForm(event) {
            event.preventDefault();
            
            document.getElementById('idNumberError').style.display = 'none';
            
            const formData = {
                FirstName: document.getElementById('firstName').value,
                LastName: document.getElementById('lastName').value,
                IDNumber: document.getElementById('idNumber').value,
                DateOfBirth: document.getElementById('dateOfBirth').value,
                Gender: document.getElementById('gender').value,
                FundID: document.getElementById('fundId').value || null
            };
            
            if (!/^\d{9}$/.test(formData.IDNumber)) {
                document.getElementById('idNumberError').style.display = 'block';
                return false;
            }
            
            try {
                const response = await fetch('/api/patients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                alert('Patient registered successfully!');
                document.getElementById('newPatientForm').reset();
            } catch (error) {
                console.error('Error:', error);
                alert('Error registering patient. Please try again.');
            }
            
            return false;
        }




    </script>
</body>

</html>